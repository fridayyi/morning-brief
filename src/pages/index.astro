---
import { getCollection } from 'astro:content';
import Base from '../layouts/Base.astro';

const dailyBriefs = (await getCollection('daily')).sort((a, b) => b.data.date.localeCompare(a.data.date));
const latest = dailyBriefs[0];
const { Content } = await latest.render();

const weekdayMap: Record<string, string> = {
  '0': '周日', '1': '周一', '2': '周二', '3': '周三',
  '4': '周四', '5': '周五', '6': '周六'
};
const d = new Date(latest.data.date + 'T00:00:00+08:00');
const weekday = latest.data.weekday || weekdayMap[d.getDay().toString()] || '';

const headlines = [
  "Trump bans Anthropic from fed agencies",
  "Block lays off 4000 — AI did it",
  "OpenAI raises $110B at $730B",
  "Figma × OpenAI Codex: bidirectional",
];
---
<Base title="Latest Brief">
  <!-- Hero -->
  <div class="hero">
    <div class="hero-text">
      <h1>
        Morning
        <span class="date-line">Brief.</span>
      </h1>
      <p class="subtitle">
        AI news that matters, curated by Friday for Yi. 
        No noise, no fluff. Just what you need to know.
      </p>
      <div class="quick-stats">
        <div>
          <span class="stat-label">Date</span>
          {latest.data.date} {weekday}
        </div>
        <div>
          <span class="stat-label">Stories</span>
          {(latest.data.tier1 || 0) + (latest.data.tier2 || 0) + (latest.data.tier3 || 0)}
        </div>
      </div>
    </div>
    <div class="hero-computer">
      <div class="mini-computer">
        <div class="mini-screen">
          <div class="screen-content">
            <div class="dim">FridayOS 1.0</div>
            <div style="margin-top: 8px;">
              <span class="prompt">$</span> morning-brief --today<br/>
              <span id="typewriter"></span><span class="cursor"></span>
            </div>
          </div>
        </div>
        <div class="mini-details">
          <div class="mini-logo"></div>
          <div class="mini-slot"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- News Content -->
  <div class="content-container">
    <article class="brief-content">
      <Content />
    </article>

    {dailyBriefs.length > 1 && (
      <section class="archive-section">
        <h2>往期</h2>
        <ul class="archive-list">
          {dailyBriefs.slice(1).map((brief) => (
            <li>
              <a href={`${import.meta.env.BASE_URL}/daily/${brief.data.date}/`} class="archive-link">
                <span class="date">{brief.data.date}</span>
                <span class="weekday">{brief.data.weekday || ''}</span>
              </a>
            </li>
          ))}
        </ul>
      </section>
    )}
  </div>

  <script define:vars={{ headlines }}>
    const speed = 60;
    let lineIdx = 0;
    let charIdx = 0;
    const target = document.getElementById("typewriter");

    function typeWriter() {
      if (!target) return;
      const line = headlines[lineIdx];
      if (charIdx < line.length) {
        target.textContent += line.charAt(charIdx);
        charIdx++;
        setTimeout(typeWriter, speed + Math.random() * 30);
      } else {
        setTimeout(() => {
          lineIdx = (lineIdx + 1) % headlines.length;
          charIdx = 0;
          target.textContent = "";
          typeWriter();
        }, 2500);
      }
    }
    typeWriter();
  </script>
</Base>

<style>
  .brief-content :global(h1) {
    display: none;
  }
  .brief-content :global(h2) {
    font-size: 1.3rem;
    font-weight: 600;
    margin: 2.5rem 0 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--ink-black);
  }
  .brief-content :global(h2:first-child) {
    margin-top: 0;
  }
  .brief-content :global(h3) {
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--ink-black);
    margin: 1.5rem 0 0.4rem;
  }
  .brief-content :global(p) {
    margin-bottom: 0.5rem;
  }
  .brief-content :global(strong) {
    color: var(--accent-fire);
    font-weight: 500;
    font-style: italic;
  }
  .brief-content :global(a) {
    color: #999;
    text-decoration: none;
    font-size: 0.85rem;
  }
  .brief-content :global(a:hover) {
    color: var(--accent-watch);
  }
</style>
